# =============================================================================
# PlanCraft Agent - Docker Compose (v2.2)
# Multi-Agent AI 기획서 생성 서비스
# =============================================================================
#
# 사용법:
#   docker-compose up -d          # 백그라운드 실행
#   docker-compose logs -f        # 로그 확인
#   docker-compose down           # 종료
#
# 환경변수 (.env 또는 .env.local 파일 필수):
#   AOAI_ENDPOINT=https://xxx.openai.azure.com/
#   AOAI_API_KEY=xxx
#   AOAI_DEPLOY_GPT4O=gpt-4o
#   AOAI_DEPLOY_GPT4O_MINI=gpt-4o-mini
#   AOAI_DEPLOY_EMBED_3_LARGE=text-embedding-3-large
#   TAVILY_API_KEY=xxx (선택)
#   LANGCHAIN_TRACING_V2=true (LangSmith 활성화)
#   LANGCHAIN_API_KEY=xxx (LangSmith API 키)
#
# =============================================================================

version: '3.8'

services:
  plancraft:
    build:
      context: .
      dockerfile: Dockerfile
    image: plancraft-agent:2.2
    container_name: plancraft-agent
    ports:
      - "8501:8501"
    env_file:
      - .env.local  # .env.local 우선 사용 (.env도 가능)
    environment:
      - PYTHONPATH=/app
      - CHECKPOINTER_TYPE=memory
      # LangSmith 트레이싱 (.env.local에서 설정됨)
      # 아래는 .env.local이 없는 경우 직접 설정
      # - LANGCHAIN_TRACING_V2=true
      # - LANGCHAIN_API_KEY=your_api_key
      # - LANGCHAIN_PROJECT=PlanCraft-Prod
    volumes:
      # 로그 및 출력 영속화
      - ./logs:/app/logs
      - ./outputs:/app/outputs
      # RAG 인덱스 영속화 (빌드 후 생성됨)
      - plancraft_rag:/app/rag/faiss_index
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G

  # -------------------------------------------------------------------------
  # (선택) PostgreSQL Checkpointer - 프로덕션 환경용
  # -------------------------------------------------------------------------
  # postgres:
  #   image: postgres:16-alpine
  #   container_name: plancraft-db
  #   environment:
  #     POSTGRES_USER: plancraft
  #     POSTGRES_PASSWORD: ${DB_PASSWORD:-changeme}
  #     POSTGRES_DB: plancraft
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data
  #   ports:
  #     - "5432:5432"
  #   restart: unless-stopped
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U plancraft"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5

volumes:
  plancraft_rag:
    name: plancraft-rag-index
  # postgres_data:

networks:
  default:
    name: plancraft-network
