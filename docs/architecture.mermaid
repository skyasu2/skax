%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#e3f2fd', 'primaryTextColor': '#1565c0', 'primaryBorderColor': '#1976d2', 'lineColor': '#64b5f6', 'secondaryColor': '#fff8e1', 'tertiaryColor': '#f3e5f5'}}}%%

graph TB
    %% ==========================================================
    %% PlanCraft Agent - ì‹œìŠ¤í…œ ì „ì²´ êµ¬ì¡°ë„
    %% ìµœì¢… ì—…ë°ì´íŠ¸: 2025-12-29
    %% ==========================================================

    %% ìŠ¤íƒ€ì¼ ì •ì˜
    classDef userStyle fill:#e8f5e9,stroke:#2e7d32,stroke-width:3px,rx:50,ry:50
    classDef uiStyle fill:#e3f2fd,stroke:#1565c0,stroke-width:2px,rx:10,ry:10
    classDef agentStyle fill:#fff3e0,stroke:#ef6c00,stroke-width:2px,rx:8,ry:8
    classDef toolStyle fill:#fce4ec,stroke:#c2185b,stroke-width:2px,rx:5,ry:5,stroke-dasharray:5,5
    classDef dbStyle fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,rx:5,ry:5
    classDef decisionStyle fill:#fffde7,stroke:#f9a825,stroke-width:2px
    classDef outputStyle fill:#e0f7fa,stroke:#00838f,stroke-width:2px,rx:10,ry:10
    classDef safetyStyle fill:#ffebee,stroke:#c62828,stroke-width:2px,rx:5,ry:5

    %% ==========================================================
    %% ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤ ê³„ì¸µ
    %% ==========================================================
    User((ğŸ‘¤ User)):::userStyle
    
    subgraph UI_Layer["ğŸ–¥ï¸ UI Layer (Streamlit)"]
        direction LR
        InputForm[ğŸ“ ì…ë ¥ í¼]:::uiStyle
        ProgressBar[â³ ì§„í–‰ ìƒíƒœ]:::uiStyle
        OutputView[ğŸ“„ ê¸°íšì„œ ì¶œë ¥]:::uiStyle
        FeedbackUI[ğŸ’¬ í”¼ë“œë°± UI]:::uiStyle
    end

    User -->|"ìš”ì²­ ì…ë ¥"| InputForm
    OutputView -->|"ê²°ê³¼ í‘œì‹œ"| User
    FeedbackUI -->|"ì¶”ê°€ ì§ˆë¬¸"| User

    %% ==========================================================
    %% LangGraph ì›Œí¬í”Œë¡œìš° ê³„ì¸µ
    %% ==========================================================
    subgraph Workflow["ğŸ”„ LangGraph Workflow (graph/workflow.py)"]
        direction TB
        
        %% Context Gathering Sub-graph
        subgraph Context["ğŸ“š Context Gathering"]
            direction LR
            RAG[(ğŸ—‚ï¸ RAG<br/>FAISS)]:::dbStyle
            Tavily[ğŸŒ Tavily<br/>ì›¹ê²€ìƒ‰]:::toolStyle
        end

        %% Agent Pipeline
        subgraph Agents["ğŸ¤– Agent Pipeline (6 Agents)"]
            direction TB
            
            Analyzer[ğŸ” Analyzer<br/>temp=0.3]:::agentStyle
            Structurer[ğŸ“‹ Structurer<br/>temp=0.5]:::agentStyle
            Writer[âœï¸ Writer<br/>temp=0.7]:::agentStyle
            Reviewer[ğŸ” Reviewer<br/>temp=0.3]:::agentStyle
            Refiner[âœ¨ Refiner<br/>temp=0.5]:::agentStyle
            Formatter[ğŸ“ Formatter<br/>temp=0.5]:::agentStyle
            
            Analyzer --> Structurer
            Structurer --> Writer
            Writer --> Reviewer
            Reviewer --> RefineCheck{ì ìˆ˜ < 9?}:::decisionStyle
            RefineCheck -->|Yes| Refiner
            Refiner -->|"Loop â‰¤ 3"| Writer
            RefineCheck -->|No/Pass| Formatter
        end

        %% Safety Check
        SafetyCheck[ğŸ›¡ï¸ RemainingSteps<br/>ë¬´í•œë£¨í”„ ë°©ì§€]:::safetyStyle
        Refiner -.->|"remaining_steps â‰¤ 5?"| SafetyCheck
        SafetyCheck -.->|"ê°•ì œ ì¢…ë£Œ"| Formatter

        %% Human Interrupt
        HumanInterrupt[ğŸ‘‹ Human<br/>Interrupt]:::decisionStyle
        Analyzer -->|"need_more_info?"| HumanInterrupt
        HumanInterrupt -->|"ì‚¬ìš©ì ì‘ë‹µ"| Analyzer
    end

    %% ==========================================================
    %% ì™¸ë¶€ ì„œë¹„ìŠ¤ ê³„ì¸µ
    %% ==========================================================
    subgraph External["â˜ï¸ External Services"]
        direction LR
        AzureOpenAI[ğŸ¤– Azure OpenAI<br/>GPT-4o / GPT-4o-mini]:::toolStyle
        TavilyAPI[ğŸ” Tavily API<br/>ì›¹ ê²€ìƒ‰]:::toolStyle
        Embeddings[ğŸ“Š Embeddings<br/>text-embedding-3-large]:::toolStyle
    end

    %% ==========================================================
    %% ë°ì´í„° ì €ì¥ì†Œ ê³„ì¸µ
    %% ==========================================================
    subgraph Storage["ğŸ’¾ Storage"]
        direction LR
        FAISSIndex[(ğŸ“ faiss_index<br/>index.faiss)]:::dbStyle
        Documents[(ğŸ“„ documents<br/>*.md)]:::dbStyle
        Logs[(ğŸ“‹ logs<br/>*.jsonl)]:::dbStyle
        Outputs[(ğŸ“¤ outputs<br/>ê¸°íšì„œ)]:::dbStyle
    end

    %% ==========================================================
    %% ì—°ê²° ê´€ê³„
    %% ==========================================================
    
    %% UI â†’ Workflow
    InputForm -->|"PlanCraftState"| Analyzer
    Context --> Analyzer
    
    %% Workflow â†’ External
    Analyzer & Writer & Reviewer -->|"LLM Call"| AzureOpenAI
    Tavily -->|"Search"| TavilyAPI
    RAG -->|"Query"| Embeddings
    
    %% Workflow â†’ Storage
    RAG --> FAISSIndex
    RAG --> Documents
    Formatter -->|"Save"| Outputs
    Workflow -->|"Log"| Logs
    
    %% Workflow â†’ UI
    Formatter -->|"final_output"| OutputView
    HumanInterrupt -->|"ì§ˆë¬¸"| FeedbackUI
